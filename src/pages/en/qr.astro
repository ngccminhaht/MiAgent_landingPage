---
import i18next from "../../i18n";
i18next.changeLanguage("en");

import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout>
  <section class="py-16 bg-gray-50">
    <div
      class="max-w-7xl mx-auto px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-3 gap-8"
    >
      <!-- Cột trái -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-6 space-y-6">
        <h2 class="text-xl font-semibold">Chuyển khoản</h2>

        <!-- QR (sẽ load bằng JS) -->
        <div class="flex justify-center">
          <img id="qrImg" alt="QR Code" class="w-60 h-60 rounded-lg shadow" />
        </div>

        <!-- Thông tin -->
        <div id="payment-info" class="space-y-4">
          <p>Đang tải thông tin thanh toán...</p>
        </div>

        <!-- Lưu ý -->
        <p class="text-sm text-yellow-700 bg-yellow-100 p-3 rounded-lg">
          Vui lòng quét mã QR hoặc nhập đúng thông tin chuyển khoản để việc
          thanh toán được ghi nhận chính xác.
        </p>
        <p class="text-xs text-gray-600">
          Trong trường hợp bạn đã thanh toán nhưng chưa nhận được tín hiệu thành
          công,
          <a href="/checkout" class="text-blue-600 underline"
            >bấm vào đây để xác nhận thanh toán</a
          >
          hoặc liên hệ 0708207777.
        </p>
      </div>

      <!-- Cột phải -->
      <aside class="bg-white rounded-2xl shadow p-6 h-fit" id="invoice-details">
        <h3 class="font-semibold text-lg mb-4">Chi tiết hóa đơn</h3>
        <p>Đang tải...</p>
      </aside>
    </div>
  </section>

  <script is:inline>
    function formatCurrency(num) {
      if (isNaN(num)) return "0 đ";
      return num.toLocaleString("vi-VN") + " đ";
    }

    const params = new URLSearchParams(window.location.search);
    const plan = params.get("plan") ?? "Không xác định";
    const months = parseInt(params.get("months") ?? "0", 10);
    const addon = parseInt(params.get("addon") ?? "0", 10);
    const total = parseInt(params.get("total") ?? "0", 10);

    const addonText = addon > 0 ? `${addon} × 10,000,000 đ` : null;
    const transferContent = `Thanh toan ${plan}`;

    // ✅ Render QR link động
    const qrUrl =
      "https://img.vietqr.io/image/mbbank-2222233666666-compact2.png" +
      "?amount=" +
      total +
      "&addInfo=" +
      encodeURIComponent(transferContent) +
      "&accountName=" +
      encodeURIComponent("NGUYEN HAI LONG");
    document.getElementById("qrImg").src = qrUrl;

    // Render cột trái (thông tin chuyển khoản)
    document.getElementById("payment-info").innerHTML = `
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-500">Ngân hàng</label>
          <input type="text" value="MBBank" disabled class="w-full border rounded-lg px-3 py-2 bg-gray-100" />
        </div>
        <div>
          <label class="block text-sm text-gray-500">Số tài khoản</label>
          <div class="flex items-center">
            <input type="text" value="2222233666666" disabled class="flex-1 border rounded-lg px-3 py-2 bg-gray-100" />
            <button class="ml-2 text-blue-600 text-sm" onclick="navigator.clipboard.writeText('2222233666666')">Copy</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-500">Số tiền chuyển khoản</label>
          <input type="text" value="${formatCurrency(total)}" disabled class="w-full border rounded-lg px-3 py-2 bg-gray-100 font-semibold" />
        </div>
        <div>
          <label class="block text-sm text-gray-500">Nội dung *</label>
          <div class="flex items-center">
            <input type="text" value="${transferContent}" disabled class="flex-1 border rounded-lg px-3 py-2 bg-gray-100" />
            <button class="ml-2 text-blue-600 text-sm" onclick="navigator.clipboard.writeText('${transferContent}')">Copy</button>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-500">Chủ tài khoản</label>
        <input type="text" value="NGUYEN HAI LONG" disabled class="w-full border rounded-lg px-3 py-2 bg-gray-100" />
      </div>
    `;

    // Render cột phải (chi tiết hóa đơn)
    document.getElementById("invoice-details").innerHTML = `
      <h3 class="font-semibold text-lg mb-4">Chi tiết hóa đơn</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Gói</span>
          <span>${plan}</span>
        </div>
        <div class="flex justify-between">
          <span>Thời hạn</span>
          <span>${months} tháng</span>
        </div>
        ${
          addonText
            ? `
          <div class="flex justify-between">
            <span>Build Bot AI</span>
            <span>${addonText}</span>
          </div>`
            : ""
        }
        <div class="flex justify-between font-semibold border-t pt-2">
          <span>Tổng tiền thanh toán</span>
          <span>${formatCurrency(total)}</span>
        </div>
      </div>
    `;
  </script>
</BaseLayout>
