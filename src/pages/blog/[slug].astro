---
// src/pages/blog/[slug].astro
import { getBlogPosts } from '@/lib/contentful'; 
import BaseLayout from '@/layouts/BaseLayout.astro';
// SỬA DÒNG NÀY: Thay thế import hàm mặc định bằng hàm tùy chỉnh
import { richTextToHtml } from '@/lib/richTextRenderer'; 
import i18next from "../../i18n"; 
i18next.changeLanguage("vi");
const currentLang = i18next.language;
const baseUrl = currentLang === "en" ? "/en" : "/vi";

// 1. getStaticPaths: Tạo đường dẫn tĩnh cho mọi bài viết (Giữ nguyên)
export async function getStaticPaths() {
  const posts = await getBlogPosts(); 
  return posts.map(post => {
    return {
      params: { slug: post.fields.slug },
      props: { postData: post }
    };
  });
}

// 2. Nhận dữ liệu (Giữ nguyên)
const { postData } = Astro.props as any; 

if (!postData) {
    return;
}

// 3. CHUYỂN ĐỔI RICH TEXT: Sử dụng hàm mới
const renderedContent = richTextToHtml(postData.fields.content as any); 

// Thiết lập dữ liệu an toàn (Giữ nguyên)
const thumbnailUrl = postData.fields.thumbnail?.fields.file.url ?? '/images/default-placeholder.jpg';
---

<BaseLayout title={postData.fields.title}>
  <main class="container py-12 max-w-4xl mx-auto">
    
    <h1 class="text-4xl font-extrabold mb-4">{postData.fields.title}</h1>
    
    <div class="text-sm text-gray-500 mb-6 flex space-x-4">
        <span>{i18next.t('blog.post.published_at')} {new Date(postData.fields.publishedAt).toLocaleDateString('vi-VN')}</span>
        <span>{i18next.t('blog.post.category')} {postData.fields.category}</span>
    </div>
    
    <img 
      src={thumbnailUrl} 
      alt={postData.fields.title} 
      class="w-full h-96 object-cover rounded-lg mb-10"
    />
    
    <div class="prose max-w-none" set:html={renderedContent} /> 
    
    <a href={baseUrl + "/blog"} class="mt-10 inline-block text-blue-600 hover:underline">
        {i18next.t('blog.post.back_to_list')}
    </a>
  </main>
</BaseLayout>